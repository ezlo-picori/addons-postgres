#!/usr/bin/with-contenv bashio
# ==============================================================================
# Start PostgreSQL service if enabled
# ==============================================================================
POSTGRES_DATA=/data/databases
# NEW_INSTALL=false

# Init database
if ! bashio::fs.directory_exists "${POSTGRES_DATA}"; then
    bashio::log.info "Create a new postgres initial system"
    initdb \
      --data-checksums \
      -D ${POSTGRES_DATA} > /dev/null
    echo "host all all 0.0.0.0/0 scram-sha-256" >> ${POSTGRES_DATA}/pg_hba.conf
    echo "list_addresses='*'" >> ${POSTGRES_DATA}/postgresql.conf
    # NEW_INSTALL=true
else
    bashio::log.info "Using existing postgres initial system"
    bashio::log.info "Checking data integrity"
    pg_checksums -D ${POSTGRES_DATA} --check
fi

# Start PostgreSQL
bashio::log.info "Starting PostgreSQL"
pg_ctl start -D ${POSTGRES_DATA}
POSTGRES_PID=$!

# Wait until DB is running
while ! psql -c "" 2> /dev/null; do
  sleep 1
done


# Init databases
bashio::log.info "Ensure databases exists"
for database in $(bashio::config "databases"); do
    if psql "${database}" -c '' &> /dev/null; then
      bashio::log.info "Database ${database} already defined"
    else
      bashio::log.info "Create database ${database}"
      psql -c "CREATE DATABASE ${database};" 2> /dev/null || true
    fi
done

# Init logins
bashio::log.info "Ensure users exists and are updated"
for login in $(bashio::config "logins|keys"); do
    USERNAME=$(bashio::config "logins[${login}].username")
    PASSWORD=$(bashio::config "logins[${login}].password")

    if psql -c "SET PASSWORD FOR '${USERNAME}'@'%' = PASSWORD('${PASSWORD}');" 2> /dev/null; then
        bashio::log.info "Update user ${USERNAME}"
    else
        bashio::log.info "Create user ${USERNAME}"
        psql -c "CREATE USER '${USERNAME}'@'%' IDENTIFIED BY '${PASSWORD}';" 2> /dev/null || true
    fi
done

# Init rights
bashio::log.info "Init/Update rights"
for right in $(bashio::config "rights|keys"); do
    USERNAME=$(bashio::config "rights[${right}].username")
    DATABASE=$(bashio::config "rights[${right}].database")

    if bashio::config.exists "rights[${right}].privileges"; then
        PRIVILEGES=$(bashio::config "rights[${right}].privileges")
        bashio::log.info "Granting ${PRIVILEGES} to ${USERNAME} on ${DATABASE}"
        psql -c "REVOKE ALL PRIVILEGES ON ${DATABASE}.* FROM '${USERNAME}'@'%';" || true
        psql -c "GRANT ${PRIVILEGES} ON ${DATABASE}.* TO '${USERNAME}'@'%';" || true
    else
        bashio::log.info "Granting all privileges to ${USERNAME} on ${DATABASE}"
        psql -c "GRANT ALL PRIVILEGES ON ${DATABASE}.* TO '${USERNAME}'@'%';" 2> /dev/null || true
    fi
done

# Generate service user
if ! bashio::fs.file_exists "/data/secret"; then
    pwgen 64 1 > /data/secret
fi
SECRET=$(</data/secret)
psql -c "CREATE USER 'service'@'172.30.32.%' IDENTIFIED BY '${SECRET}';" 2> /dev/null || true
psql -c "CREATE USER 'service'@'172.30.33.%' IDENTIFIED BY '${SECRET}';" 2> /dev/null || true
psql -c "GRANT ALL PRIVILEGES ON *.* TO 'service'@'172.30.32.%' WITH GRANT OPTION;" 2> /dev/null || true
psql -c "GRANT ALL PRIVILEGES ON *.* TO 'service'@'172.30.33.%' WITH GRANT OPTION;" 2> /dev/null || true

# Flush privileges
psql -c "FLUSH PRIVILEGES;" 2> /dev/null || true

# Send service information to the Supervisor
PAYLOAD=$(\
    bashio::var.json \
        host "$(hostname)" \
        port "^3306" \
        username "service" \
        password "${SECRET}"
)
if bashio::services.publish "postgresql" "${PAYLOAD}"; then
    bashio::log.info "Successfully send service information to Home Assistant."
else
    bashio::log.warning "Service message to Home Assistant failed!"
fi

# Register stop
function stop_postgres() {
    bashio::services.delete "postgresql"
    pg_ctl stop -D ${POSTGRES_DATA}
    # Successful exit, avoid wait exit status to propagate
    exit 0
}
trap "stop_postgres" SIGTERM SIGHUP

wait "${POSTGRES_PID}"